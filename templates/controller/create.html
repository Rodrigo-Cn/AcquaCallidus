{% extends "base.html" %}
{% load static %}
{% block title %}Cadastro de Controlador{% endblock %}

{% block content %}
<div class="antialiased font-sans min-h-[800px] bg-gray-100">
  <div class="container mx-auto py-10 px-4 sm:px-6 lg:px-8">

    <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-full mx-auto">

      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 gap-4">
        <h2 class="text-2xl font-bold text-gray-800">
          Cadastro de Controlador de Irrigação
        </h2>
        <a
          href="javascript:history.back()"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-medium 
                 text-white bg-sky-600 rounded-xl shadow-md 
                 hover:bg-sky-700 focus:outline-none 
                 focus:ring-2 focus:ring-offset-2 focus:ring-sky-300 transition"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
          Voltar
        </a>
      </div>

      <form method="POST" action="" class="space-y-6">
        {% csrf_token %}

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Nome</label>
            <input type="text" id="name" name="name" value="Controlador Principal"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
          </div>

          <div>
            <label for="device" class="block text-sm font-semibold text-gray-700 mb-1">Dispositivo</label>
            <input type="text" id="device" name="device" value="ESP32-ABC123"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
          </div>

          <div>
            <label for="ip_address" class="block text-sm font-semibold text-gray-700 mb-1">Endereço IP</label>
            <input type="text" id="ip_address" name="ip_address" value="192.168.0.10"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
          </div>

          <div>
            <label for="phase_vegetable" class="block text-sm font-semibold text-gray-700 mb-1">Fase do Cultivo</label>
            <select id="phase_vegetable" name="phase_vegetable"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3">
              <option value="1" selected>Inicial</option>
              <option value="2">Vegetativa</option>
              <option value="3">Floração</option>
              <option value="4">Frutificação</option>
              <option value="5">Maturação</option>
            </select>
          </div>

          <div class="flex items-center gap-3">
            <input type="checkbox" id="status" name="status" checked
              class="w-5 h-5 text-sky-600 border-gray-300 rounded focus:ring-sky-500"/>
            <label for="status" class="text-sm font-semibold text-gray-700">Ativo</label>
          </div>

          <div>
            <label for="last_irrigation" class="block text-sm font-semibold text-gray-700 mb-1">Última Irrigação</label>
            <input type="date" id="last_irrigation" name="last_irrigation"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
          </div>

          <div>
            <label for="culturevegetable" class="block text-sm font-semibold text-gray-700 mb-1">Cultura</label>
            <select id="culturevegetable" name="culturevegetable"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3">
              <option value="">-- Selecione --</option>
              <option value="1" selected>Tomate</option>
              <option value="2">Alface</option>
              <option value="3">Cenoura</option>
              <option value="4">Pimentão</option>
            </select>
          </div>

          <div>
            <label for="geolocation" class="block text-sm font-semibold text-gray-700 mb-1">Geolocalização</label>
            <select id="geolocation" name="geolocation"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3">
              <option value="">-- Selecione --</option>
              <option value="1" selected>Estufa Norte</option>
              <option value="2">Estufa Sul</option>
              <option value="3">Campo Aberto</option>
              <option value="4">Hidroponia</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Válvulas</label>
          <div id="valve-container" class="space-y-3"></div>
          <button type="button" id="add-valve" 
            class="mt-3 flex items-center justify-center w-10 h-10 bg-sky-600 text-white rounded-full hover:bg-sky-700 transition">
            +
          </button>
          <p class="text-xs text-gray-500 mt-1">Máximo de 3 válvulas por controlador</p>
        </div>

        <div class="flex justify-end pt-4">
          <button type="submit"
            class="w-full sm:w-auto px-6 py-3 text-white text-base font-medium bg-sky-600 rounded-xl shadow-md 
                   hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-300 transition">
             Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const valveContainer = document.getElementById("valve-container");
  const addValveBtn = document.getElementById("add-valve");
  let valveCount = 0;
  const maxValves = 3;

  const irrigationInput = document.getElementById("last_irrigation");
  const today = new Date().toISOString().split("T")[0];
  irrigationInput.value = today;

  function toggleAddButton() {
    addValveBtn.style.display = valveCount >= maxValves ? "none" : "flex";
  }

  function updateDeleteButtons() {
    const allValves = valveContainer.querySelectorAll(".valve-field");
    allValves.forEach(v => {
      const btn = v.querySelector(".remove-valve");
      if (btn) btn.remove();
    });
    if (allValves.length > 1) {
      allValves.forEach(v => {
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "remove-valve bg-red-500 text-white w-10 h-10 rounded-full hover:bg-red-600 flex items-center justify-center";
        deleteBtn.innerHTML = "×";
        v.appendChild(deleteBtn);

        deleteBtn.addEventListener("click", () => {
          v.remove();
          valveCount--;
          toggleAddButton();
          updateDeleteButtons();
        });
      });
    }
  }

  function createValveField() {
    valveCount++;
    const div = document.createElement("div");
    div.className = "valve-field flex flex-col sm:flex-row gap-2";

    div.innerHTML = `
      <input type="number" name="valves[${valveCount}][plants]" placeholder="Qtd. Plantas" 
        class="w-full sm:w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
      <input type="number" step="0.1" name="valves[${valveCount}][radius]" placeholder="Raio de Irrigação (m)" 
        class="w-full sm:w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
    `;

    valveContainer.appendChild(div);
    toggleAddButton();
    updateDeleteButtons();
  }

  addValveBtn.addEventListener("click", () => {
    if (valveCount < maxValves) {
      createValveField();
    }
  });

  createValveField();
</script>
{% endblock %}
