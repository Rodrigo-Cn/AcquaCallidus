{% extends "base.html" %}
{% load static %} 
{% block title %}Meus Controladores{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/controller/secret-code.js' %}"></script>
<script src="{% static 'js/controller/delete.js' %}"></script>
<script src="{% static 'js/controller/modal.js' %}"></script>
<script src="{% static 'css/controller/style.css' %}"></script>
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<link href="{% static 'css/controller/style.css' %}" rel="stylesheet" />
<div class="antialiased font-sans min-h-[800px] bg-gray-200">
  <div class="container mx-auto py-2 px-4 sm:px-8">
    <div class="py-12">
      <div>
        <h2 class="text-2xl font-semibold leading-tight text-gray-800">
          Meus Controladores
        </h2>
      </div>

      <div class="mt-6 mb-9 flex sm:flex-row flex-col">
        <form
          class="flex max-w-md w-full"
          method="GET"
          action="{% url 'controllers_list' %}"
        >
          <label for="simple-search" class="sr-only">Search</label>

          <div class="relative w-full">
            <div
              class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-gray-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9.75 3v2.25M14.25 3v2.25M9.75 18.75V21M14.25 18.75V21M3 9.75h2.25M3 14.25h2.25M18.75 9.75H21M18.75 14.25H21M7.5 6h9a1.5 1.5 0 011.5 1.5v9a1.5 1.5 0 01-1.5 1.5h-9A1.5 1.5 0 016 16.5v-9A1.5 1.5 0 017.5 6z"
                />
              </svg>
            </div>
            <input
              type="text"
              id="simple-search"
              class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5 placeholder-gray-400"
              placeholder="Pesquisar..."
              name="name"
              value="{{ name_query }}"
            />
          </div>
          <button
            type="submit"
            class="p-2.5 ms-2 text-sm font-medium text-white bg-sky-500 dark:bg-sky-700 rounded-full border border-sky-500 dark:border-sky-700 hover:bg-sky-600 dark:hover:bg-sky-800 focus:ring-4 focus:outline-none focus:ring-sky-300 dark:focus:ring-sky-900"
          >
            <svg
              class="w-4 h-4"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 20 20"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"
              />
            </svg>
            <span class="sr-only">Search</span>
          </button>
          <button
            type="button"
            class="p-2.5 ms-2 text-sm font-medium text-white bg-sky-500 dark:bg-sky-700 rounded-full border border-sky-500 dark:border-sky-700 hover:bg-sky-600 dark:hover:bg-sky-800 focus:ring-4 focus:outline-none focus:ring-sky-300 dark:focus:ring-sky-900"
            id="openPopupController" 
          >
            <svg
              class="w-4 h-4"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4v16m8-8H4"
              />
            </svg>
            <span class="sr-only">Adicionar</span>
          </button>
        </form>
      </div>

      <div
        id="alert-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
      >
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
          <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Atenção</h3>
            <button
              id="close-modal-btn"
              class="text-gray-400 text-3xl leading-none hover:text-gray-600"
            >
              &times;
            </button>
          </div>
          <div class="p-6">
            <p id="modal-message" class="text-gray-700"></p>
          </div>
          <div class="flex justify-end p-4 bg-gray-50 rounded-b-lg">
            <button
              id="ok-modal-btn"
              class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400"
            >
              OK
            </button>
          </div>
        </div>
      </div>

      {% if page_obj %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-12 mb-12">
          {% for controller in page_obj %}
            <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 p-6 relative flex flex-col border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                  <div class="p-2 bg-blue-100 rounded-xl">
                    <i data-lucide="cpu" class="w-6 h-6 text-sky-600"></i>
                  </div>
                  <div>
                    <h2 class="text-lg font-bold text-gray-800">{{ controller.name }}</h2>
                    <p class="text-xs text-gray-500">Dispositivo: {{ controller.device }}</p>
                  </div>
                </div>
                {% if controller.status %}
                  <span class="text-[11px] font-bold px-3 py-1 rounded-full text-white bg-green-600 shadow">
                    Online
                  </span>
                {% else %}  
                  <span class="text-[11px] font-bold px-3 py-1 rounded-full text-white bg-gray-400 shadow">
                    Offline
                  </span>
                {% endif %}
              </div>
              <div class="absolute top-16 right-4 flex flex-col items-center gap-2">
                <button onclick="toggleSecret(this)" 
                  class="text-sky-500 hover:text-sky-800 transition p-2 rounded-xl hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-300">
                  <i data-lucide="eye" class="w-4 h-4"></i>
                </button>
                <button onclick="openDeviceCode()" class="text-sky-500 hover:text-sky-800 transition p-2 rounded-xl hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-300">
                  <i id="code-icon" data-lucide="code-xml" class="w-4 h-4"></i>
                </button>
                <button class="text-sky-500 hover:text-sky-800 transition p-2 rounded-xl hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-300">
                  <i data-lucide="droplet" class="w-4 h-4"></i>
                </button>
                <button onclick="editController({{ controller.id }})" class="text-sky-500 hover:text-sky-800 transition p-2 rounded-xl hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-300">
                  <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                <button class="text-red-600 transition p-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-300" onclick="openDeleteControllerModal({{ controller.id }})">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>

              <div class="space-y-3 text-gray-700 text-sm">
                <div class="flex items-center">
                  <i data-lucide="lock" class="w-5 h-5 mr-2 text-gray-500"></i>
                  <p>
                    <strong>Chave Secreta:</strong> 
                    <span class="secret-code" data-code="{{ controller.security_code }}">****************</span>
                  </p>
                </div>

                <div class="flex items-center">
                  <i data-lucide="wifi" class="w-5 h-5 mr-2 text-gray-500"></i>
                  <p><strong>IP:</strong> {{ controller.ip_address }}</p>
                </div>

                <div class="flex items-center">
                  <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-gray-500"></i>
                  <p><strong>Localização:</strong> {{ controller.geolocation.city }} - {{ controller.geolocation.state }}</p>
                </div>

                <div class="flex items-center">
                  {% if controller.phase_vegetable == 1 %}
                    <i data-lucide="sprout" class="w-5 h-5 mr-2 text-green-600"></i> 
                  {% elif controller.phase_vegetable == 2 %}
                    <i data-lucide="leaf" class="w-5 h-5 mr-2 text-green-600"></i> 
                  {% elif controller.phase_vegetable == 3 %}
                    <i data-lucide="flower" class="w-5 h-5 mr-2 text-pink-500"></i> 
                  {% elif controller.phase_vegetable == 4 %}
                    <i data-lucide="apple" class="w-5 h-5 mr-2 text-red-500"></i> 
                  {% elif controller.phase_vegetable == 5 %}
                    <i data-lucide="package" class="w-5 h-5 mr-2 text-yellow-600"></i> 
                  {% endif %}
                  <p>
                    <strong>Cultura:</strong> {{ controller.culturevegetable.name }} 
                    {% if controller.phase_vegetable == 1 %}
                      (Fase Inicial)
                    {% elif controller.phase_vegetable == 2 %}
                      (Fase Vegetativa)
                    {% elif controller.phase_vegetable == 3 %}
                      (Fase de Floração)
                    {% elif controller.phase_vegetable == 4 %}
                      (Fase de Frutificação)
                    {% elif controller.phase_vegetable == 5 %}
                      (Fase de Maturação)
                    {% endif %}
                  </p>
                </div>

                <div class="flex items-center">
                  <i data-lucide="clock" class="w-5 h-5 mr-2 text-gray-500"></i>
                  <p><strong>Última Irrigação:</strong> {{ controller.last_irrigation }}</p>
                </div>
              </div>

              <div class="mt-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Válvulas</h3>
                  <div class="grid grid-cols-3 gap-3">
                    {% for valve in controller.valves_fixed %}
                      {% if valve %}
                        <button type="button" data-valve="{{ forloop.counter }}" onclick=""
                          class="flex flex-col items-center bg-green-50 rounded-xl p-3 shadow-sm hover:shadow-lg transition-transform transform hover:scale-105 w-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-300">
                          {% if valve.status %}
                            <i data-lucide="droplet" class="w-6 h-6 text-blue-600"></i>
                          {% else %}
                            <i data-lucide="droplet" class="w-6 h-6 text-red-600"></i>
                          {% endif %}
                          <p class="text-xs mt-1 font-semibold text-green-700">Válvula {{ forloop.counter }}</p>
                          <span class="text-[11px] text-green-600">Ativa</span>
                          <span class="text-[10px] text-gray-700 mt-1">Plantas: {{ valve.plants_number }}</span>
                          <span class="text-[10px] text-gray-700 mt-1"><strong>Área:</strong> {{ valve.irrigation_radius }} m²</span>
                        </button>
                      {% else %}
                        <div class="flex flex-col items-center bg-red-50 rounded-xl p-3 shadow-sm w-full opacity-70 cursor-not-allowed">
                          <i data-lucide="droplet" class="w-6 h-6 text-red-600"></i>
                          <p class="text-xs mt-1 font-semibold text-red-700">Válvula {{ forloop.counter }}</p>
                          <span class="text-[11px] text-red-600">Inativa</span>
                          <span class="text-[10px] text-gray-500 mt-1">Plantas: 0</span>
                          <span class="text-[10px] text-gray-500 mt-1"><strong>Área:</strong> 0 m²</span>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
              </div>
            </div>
          {% endfor %}
      </div>
    {% else %}
      <div
        class="flex flex-col items-center justify-center py-16 px-4 text-center"
      >
        <svg
          class="w-16 h-16 text-gray-400 mb-4"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <h3 class="text-lg font-semibold text-gray-700">
          Nenhum registro encontrado
        </h3>
        <p class="mt-2 text-sm text-gray-500">
          Tente ajustar a busca ou adicionar novos registros para
          visualizá-lo aqui.
        </p>
      </div>
    {% endif %}
      
    {% if page_obj.has_next or page_obj.has_previous %}
      <div class="flex justify-center mb-8">
        {% if page_obj.has_previous %}
          <a
            href="?page={{ page_obj.previous_page_number }}{% if name_query %}&name={{ name_query }}{% endif %}"
            class="flex items-center justify-center px-3 h-8 me-3 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700"
          >
            <svg class="w-3.5 h-3.5 me-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M13 5H1m0 0 4 4M1 5l4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
            Anterior
          </a>
        {% else %}
          <button
            class="flex items-center justify-center px-3 h-8 me-3 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
            disabled
          >
            <svg class="w-3.5 h-3.5 me-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M13 5H1m0 0 4 4M1 5l4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
            Anterior
          </button>
        {% endif %}

        <span class="flex items-center text-gray-700 text-sm font-medium select-none me-3">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
          <a
            href="?page={{ page_obj.next_page_number }}{% if name_query %}&name={{ name_query }}{% endif %}"
            class="flex items-center justify-center px-3 h-8 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700"
          >
            Próxima
            <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M1 5h12m0 0L9 1m4 4L9 9" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
          </a>
        {% else %}
          <button
            class="flex items-center justify-center px-3 h-8 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
            disabled
          >
            Próxima
            <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M1 5h12m0 0L9 1m4 4L9 9" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
          </button>
        {% endif %}
      </div>
    {% endif %}
    </div>
  </div>
  <div
    id="deleteControllerModal"
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden transition-opacity duration-300"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modalTitle"
    aria-describedby="modalDesc"
  >
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 relative transform scale-95 transition-transform duration-300">
      <button
        id="cancelControllerModalBtnTop"
        aria-label="Fechar modal"
        class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors"
        type="button"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <h2 id="modalTitle" class="text-xl font-bold mb-3 text-gray-900">Confirmação de exclusão</h2>
      <p id="modalDesc" class="text-gray-700 mb-6 leading-relaxed text-sm">
        Tem certeza que deseja deletar esta cultura vegetal? Esta ação não poderá ser desfeita.
      </p>
      <div class="flex justify-center gap-3">
        <button
          type="button"
          id="cancelControllerModalBtnBottom"
          class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold text-sm transition"
        >
          Cancelar
        </button>
        <button
          type="button"
          id="confirmDeleteControllerBtn"
          class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold text-sm transition shadow-md hover:shadow-lg"
        >
          Confirmar exclusão
        </button>
      </div>
    </div>
  </div>
  <div id="popupControlador" class="fixed inset-0 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">

      <div id="fecharFundoControlador" class="fixed inset-0 bg-black bg-opacity-50"></div>

      <div class="relative bg-white shadow-2xl rounded-2xl w-full max-w-4xl mx-auto p-6 overflow-y-auto max-h-[95vh]">

        <div class="flex justify-between items-center border-b pb-4 mb-6">
          <h2 class="text-xl font-bold text-gray-800">Cadastro de Controlador</h2>
          <button id="closePopupController" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>

        <form method="POST" id="formController" action="/controllers/store/" class="space-y-6">
          {% csrf_token %}

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label for="nomeControlador" class="block text-sm font-semibold text-gray-700 mb-1">Nome</label>
              <input type="text" id="nomeControlador" name="name" placeholder="Ex: Controlador Principal" required
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
            </div>

            <div>
              <label for="dispositivoControlador" class="block text-sm font-semibold text-gray-700 mb-1">Dispositivo</label>
              <input type="text" id="dispositivoControlador" name="device" placeholder="Ex: ESP32" required
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
            </div>

            <div>
              <label for="ipControlador" class="block text-sm font-semibold text-gray-700 mb-1">Endereço IP</label>
              <input type="text" id="ipControlador" name="ip_address" placeholder="Ex: 192.168.0.10" required
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
            </div>

            <div>
              <label for="faseControlador" class="block text-sm font-semibold text-gray-700 mb-1">Fase do Cultivo</label>
              <select id="faseControlador" name="phase_vegetable" required
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3">
                <option value="" disabled selected>Selecione</option>
                <option value="1">🌱 Inicial</option>
                <option value="2">🌿 Vegetativa</option>
                <option value="3">🌸 Floração</option>
                <option value="4">🍒 Frutificação</option>
                <option value="5">🍂 Maturação</option>
              </select>
            </div>

            <div class="flex items-center gap-3">
              <input type="checkbox" id="statusControlador" name="active" checked
                class="w-5 h-5 text-sky-600 border-gray-300 rounded focus:ring-sky-500"/>
              <label for="statusControlador" class="text-sm font-semibold text-gray-700">Ativo</label>
            </div>

            <div>
              <label for="irrigacaoControlador" class="block text-sm font-semibold text-gray-700 mb-1">Última Irrigação</label>
              <input type="date" id="irrigacaoControlador" name="last_irrigation" required
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-3"/>
            </div>

            <div>
              <label for="culturaControlador" class="block text-sm font-semibold text-gray-700 mb-1">Cultura</label>
              <select id="culturaControlador" name="culturevegetable" required class="select2-popup" data-placeholder="Selecione uma cultura">
                <option></option>
                {% for culture_vegetable in cultures_vegetables %}
                  <option value="{{ culture_vegetable.id }}">{{ culture_vegetable.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label for="geoControlador" class="block text-sm font-semibold text-gray-700 mb-1">Geolocalização</label>
              <select id="geoControlador" name="geolocation" required class="select2-popup" data-placeholder="Selecione uma geolocalização">
                <option></option>
                {% for geolocation in geolocations %}
                  <option value="{{ geolocation.id }}">{{ geolocation.city }} - {{ geolocation.state }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Válvulas</label>
            <div id="popup-valve-container" class="space-y-3"></div>
            <button type="button" id="popup-add-valve" 
              class="mt-3 flex items-center justify-center w-10 h-10 bg-sky-600 text-white rounded-full hover:bg-sky-700 transition">
              +
            </button>
            <p class="text-xs text-gray-500 mt-1">Máximo de 3 válvulas por controlador</p>
          </div>

          <div class="flex justify-end pt-4">
            <button type="submit"
              class="w-full sm:w-auto px-6 py-3 text-white text-base font-medium bg-sky-600 rounded-xl shadow-md 
                     hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-300 transition">
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
