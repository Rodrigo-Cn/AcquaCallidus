{% extends "base.html" %}
{% load static %} 
{% block title %}Volumes de Irrigações{% endblock %}
{% block content %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<link href="{% static 'css/irrigationvolume/style.css' %}" rel="stylesheet" />
<script src="{% static 'js/irrigationvolume/select2.js' %}"></script>
<script src="{% static 'js/irrigationvolume/modal.js' %}"></script>
<script src="{% static 'js/irrigationvolume/delete.js' %}"></script>
<script src="{% static 'js/meteorologicaldata/select2.js' %}"></script>
<script>window.cultureId = "{{ culture_id }}";</script>
<div class="antialiased font-sans min-h-[800px] bg-gray-200">
  <div class="container mx-auto py-2 px-4 sm:px-8">
    <div class="py-12">
      <div class="flex items-center">
        <div class="relative">
          <h2 class="text-2xl font-semibold leading-tight text-gray-800 pr-6">
            Volumes para Irrigação por Tipo de Vegetal (Kc)
          </h2>
          <div class="absolute bottom-0 right-0 group">
            <button
              type="button"
              class="p-0.5 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600"
            >
              <svg
                class="w-3.5 h-3.5 text-gray-600 dark:text-gray-200"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z"
                />
              </svg>
            </button>
            <div
              class="absolute z-10 hidden group-hover:block w-64 p-2 text-xs text-white bg-gray-800 rounded-lg shadow-lg -top-12 start-1/2 -translate-x-1/2"
            >
              Os volumes de irrigação não levam em conta a área de irrigação nem
              a quantidade de plantas.
            </div>
          </div>
        </div>
      </div>

      <div class="my-4 flex sm:flex-row flex-col">
        <form
          id="culture-form"
          class="flex max-w-md w-full relative"
          autocomplete="off"
          method="GET"
          action="{% url 'irrigationvolume_list_cultures' %}"
        >
          <div class="relative w-full">
            <select id="culture-select" name="culture_id">
              <option value="">Selecione o tipo de vegetal</option>
              {% for culturevegetable in culturesvegetables %}
                <option value="{{ culturevegetable.id }}" {% if culture_id|stringformat:"s" == culturevegetable.id|stringformat:"s" %}selected{% endif %}>
                  {{ culturevegetable.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <button
            type="submit"
            class="p-2.5 ms-2 text-sm font-medium text-white bg-sky-500 dark:bg-sky-700 rounded-full border border-sky-500 dark:border-sky-700 hover:bg-sky-600 dark:hover:bg-sky-800 focus:ring-4 focus:outline-none focus:ring-sky-300 dark:focus:ring-sky-900"
          >
            <svg
              class="w-4 h-4"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 20 20"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"
              />
            </svg>
            <span class="sr-only">Pesquisar</span>
          </button>
        </form>
      </div>

      <div
        id="alert-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
      >
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
          <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Atenção</h3>
            <button
              id="close-modal-btn"
              class="text-gray-400 text-3xl leading-none hover:text-gray-600"
            >
              &times;
            </button>
          </div>
          <div class="p-6">
            <p id="modal-message" class="text-gray-700"></p>
          </div>
          <div class="flex justify-end p-4 bg-gray-50 rounded-b-lg">
            <button
              id="ok-modal-btn"
              class="dark:bg-sky-700 text-white px-4 py-2 rounded-lg hover:dark:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-sky-400"
            >
              OK
            </button>
          </div>
        </div>
      </div>

      {% if page_obj or culture_id %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-12 mb-12">       

        {% if culture_id %}
          <div
            class="bg-gradient-to-br from-white to-sky-50 rounded-2xl shadow-xl p-8 border border-sky-200 h-full flex flex-col"
          >
            <div class="flex flex-col items-center justify-center text-center flex-grow">
              <div class="mb-4 dark:text-sky-800">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-16 h-16"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 2.25c-2.485 3.305-5.25 6.908-5.25 9.75a5.25 5.25 0 0010.5 0c0-2.842-2.765-6.445-5.25-9.75z"
                  />
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-gray-800">
                Gerar Dados Diários Para Irrigação
              </h2>
              <p class="text-sm text-gray-500 mt-1 mb-6">
                Dados para hoje, 3 de julho de 2025
              </p>
            </div>

            <div class="my-4 flex flex-col sm:flex-row items-center justify-center gap-3 w-full max-w-md mx-auto">
              <form 
                id="geolocation-form"
                class="flex flex-col w-full"
                autocomplete="off"
                method="GET"
                action=""
              >
                <input type="hidden" id="culture-id" name="culture_id" value="{{ culture_id }}">
                <div class="relative w-full">
                  <select id="geolocation-select" name="geolocation_id" required>
                    <option value="">Selecione a cidade</option>
                    {% for geolocation in geolocations %}
                      <option value="{{ geolocation.id }}" {% if geolocation_id|stringformat:"s" == geolocation.id|stringformat:"s" %}selected{% endif %}>
                        {{ geolocation.property_name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <button
                  type="button"
                  onclick="prepareModal()"
                  class="mt-4 inline-flex items-center justify-center px-3 py-3 font-semibold text-white dark:bg-sky-700 rounded-full shadow-lg
                        transition-transform transform hover:scale-105 hover:dark:bg-sky-800 focus:outline-none focus:ring-4 focus:ring-sky-500 w-auto max-w-[180px] mx-auto"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-white-600" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.1-.3 2.13-.82 3.01l1.46 1.46C19.41 14.35 20 13.23 20 12c0-4.42-3.58-8-8-8zm-6 6c0-1.1.3-2.13.82-3.01L5.36 5.53C4.59 6.65 4 7.77 4 9c0 4.42 3.58 8 8 8v3l4-4-4-4v3c-3.31 0-6-2.69-6-6z"/>
                  </svg>
                  Atualizar Agora
                </button>
              </form>
            </div>
          </div>

          <div id="generate-modal" tabindex="-1"
            class="hidden fixed inset-0 z-[9999] bg-black bg-opacity-50 flex items-center justify-center px-4">
            
            <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative z-[10000]">
              <button type="button"
                class="absolute top-3 right-3 text-gray-400 hover:text-gray-900"
                onclick="hideModal()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>

              <div class="flex justify-center mb-4">
                <div class="w-28 h-28 rounded-full bg-sky-100 flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg"
                      fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="w-14 h-14 dark:text-sky-700">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                </div>
              </div>

              <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">
                Gerar dados de irrigação de hoje?
              </h3>

              <div class="flex justify-center gap-4 mt-4">
                <a href="#" id="confirm-button"
                  class="text-white dark:bg-sky-700 hover:dark:bg-sky-800 focus:ring-4 focus:outline-none 
                        focus:ring-sky-300 font-medium rounded-lg text-sm px-5 py-2.5">
                  Confirmar
                </a>
                <button type="button"
                  class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 
                        rounded-lg hover:bg-gray-100 hover:text-black-600 focus:outline-none 
                        focus:ring-2 focus:ring-gray-200"
                  onclick="hideModal()">
                  Cancelar
                </button>
              </div>
            </div>
          </div>

          <div
            id="alert-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
          >
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
              <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Atenção</h3>
                <button
                  id="close-modal-btn"
                  class="text-gray-400 text-3xl leading-none hover:text-gray-600"
                >
                  &times;
                </button>
              </div>
              <div class="p-6">
                <p id="modal-message" class="text-gray-700"></p>
              </div>
              <div class="flex justify-end p-4 bg-gray-50 rounded-b-lg">
                <button
                  id="ok-modal-btn"
                  class="dark:bg-sky-700 text-white px-4 py-2 rounded-lg hover:dark:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-sky-500"
                >
                  OK
                </button>
              </div>
            </div>
          </div>

        {% endif %}

        {% for irrigationvolume in page_obj %}
          <div class="bg-gradient-to-br from-white to-white rounded-2xl shadow-lg p-6 border border-sky-100 hover:shadow-2xl transition-shadow duration-300 w-full max-w-md mx-auto relative">
            
            {% if irrigationvolume.date == today and culture_id %}
              <button
                type="button"
                id="openModalBtn-{{ irrigationvolume.id }}"
                class="absolute top-4 right-4 text-red-500 hover:text-red-700 transition"
                onclick="openDeleteModal({{ irrigationvolume.id }})"
                title="Deletar dados"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M3 6h18v2H3V6zm2 3h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9zm5 3v6h2v-6H10zm4 0v6h2v-6h-2zM9 4h6v2H9V4z"
                  />
                </svg>
              </button>
            {% endif %}

            <div class="flex items-center justify-between mb-5">
              <div>
                <h2 class="text-2xl font-extrabold text-gray-700 italic tracking-tight">{{ irrigationvolume.culturevegetable.name }}</h2>
                <p class="text-sm text-gray-500 italic mt-1 flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" 
                      class="h-4 w-4 text-sky-700 dark:text-sky-500" 
                      viewBox="0 0 512 512" 
                      fill="currentColor" 
                      aria-hidden="true">
                    <path d="M256 64c-8 0-16 2-22 6L96 176v224c0 26 22 48 48 48h224c26 0 48-22 48-48V176L278 70c-6-4-14-6-22-6zm0 48 128 96v192c0 8-8 16-16 16H144c-8 0-16-8-16-16V208l128-96z"/>
                    <path d="M64 400c64-48 160-48 224 0 64-48 160-48 224 0v16H64v-16z" opacity="0.7"/>
                  </svg>
                  <strong>{{ irrigationvolume.meteorologicaldata.geolocation.property_name }}</strong>
                </p>
                <p class="text-sm text-gray-500 italic flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 dark:text-sky-700" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
                  </svg>
                  <strong>{{ irrigationvolume.meteorologicaldata.geolocation.city }} - {{ irrigationvolume.meteorologicaldata.geolocation.state }}</strong>
                </p>
                <p class="text-sm text-gray-500 italic flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 dark:text-sky-700" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                  </svg>
                  <strong>{{ irrigationvolume.date }}</strong>
                </p>
                <p class="text-sm text-gray-500 italic mt-1">Estádios de Desenvolvimento</p>
              </div>

              <div class="text-5xl text-emerald-500">
                {% if irrigationvolume.culturevegetable.emoji %}
                  {{ irrigationvolume.culturevegetable.emoji }}
                {% else %}
                  🌾
                {% endif %}
              </div>
            </div>

            <div class="grid gap-3 text-sm text-gray-800">
              <div class="flex items-center bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition">
                <span class="mr-3 text-lg">🌱</span>
                <span>Inicial: <strong class="text-gray-900">{{ irrigationvolume.phase_initial|floatformat:2 }} Litros</strong></span>
              </div>
              <div class="flex items-center bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition">
                <span class="mr-3 text-lg">🌿</span>
                <span>Vegetativo: <strong class="text-gray-900">{{ irrigationvolume.phase_vegetative|floatformat:2 }} Litros</strong></span>
              </div>
              <div class="flex items-center bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition">
                <span class="mr-3 text-lg">🌸</span>
                <span>Floração: <strong class="text-gray-900">{{ irrigationvolume.phase_flowering|floatformat:2 }} Litros</strong></span>
              </div>
              <div class="flex items-center bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition">
                <span class="mr-3 text-lg">🍎</span>
                <span>Frutificação: <strong class="text-gray-900">{{ irrigationvolume.phase_fruiting|floatformat:2 }} Litros</strong></span>
              </div>
              <div class="flex items-center bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition">
                <span class="mr-3 text-lg">🍂</span>
                <span>Maturação: <strong class="text-gray-900">{{ irrigationvolume.phase_maturation|floatformat:2 }} Litros</strong></span>
              </div>
            </div>
          </div>
          
        {% if irrigationvolume.date == today and culture_id %}
          <div
            id="deleteModal-{{ irrigationvolume.id }}"
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 z-[9999]"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modalTitle"
            aria-describedby="modalDesc"
          >
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative transform scale-95 transition-transform duration-300 z-[10000]">
              <button
                type="button"
                id="cancelModalBtnTop-{{ irrigationvolume.id }}"
                aria-label="Fechar modal"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"
                onclick="closeDeleteModal({{ irrigationvolume.id }})"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>

              <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-900">Confirmação de exclusão</h2>
              <p id="modalDesc" class="text-gray-700 mb-8 leading-relaxed">
                Tem certeza que deseja deletar os volumes de irrigação de hoje? Esta ação não poderá ser desfeita.
              </p>

              <form method="post" action="{% url 'delete_irrigationvolume' irrigationvolume.id %}?culture_id={{ culture_id }}&page={{ page_obj.number }}">
                {% csrf_token %}
                <div class="flex justify-center gap-4">
                  <button
                    type="button"
                    id="cancelModalBtnBottom-{{ irrigationvolume.id }}"
                    onclick="closeDeleteModal({{ irrigationvolume.id }})"
                    class="px-5 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold transition"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    class="px-5 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition shadow-md hover:shadow-lg"
                  >
                    Confirmar exclusão
                  </button>
                </div>
              </form>
            </div>
          </div>
        {% endif %}

      {% endfor %}

      </div>

    {% else %}
      <div
        class="flex flex-col items-center justify-center py-16 px-4 text-center"
      >
        <svg
          class="w-16 h-16 text-gray-400 mb-4"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <h3 class="text-lg font-semibold text-gray-700">
          Nenhum registro encontrado
        </h3>
        <p class="mt-2 text-sm text-gray-500">
          Tente ajustar a busca ou adicionar novos registros para
          visualizá-lo aqui.
        </p>
      </div>
    {% endif %}
      
    {% if page_obj.has_next or page_obj.has_previous %}
      <div class="flex justify-center mb-8">
        {% if page_obj.has_previous %}
          <a
            href="?page={{ page_obj.previous_page_number }}{% if culture_id %}&culture_id={{ culture_id }}{% endif %}"
            class="flex items-center justify-center px-3 h-8 me-3 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700"
          >
            <svg class="w-3.5 h-3.5 me-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M13 5H1m0 0 4 4M1 5l4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
            Anterior
          </a>
        {% else %}
          <button
            class="flex items-center justify-center px-3 h-8 me-3 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
            disabled
          >
            <svg class="w-3.5 h-3.5 me-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M13 5H1m0 0 4 4M1 5l4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
            Anterior
          </button>
        {% endif %}

        <span class="flex items-center text-gray-700 text-sm font-medium select-none me-3">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
          <a
            href="?page={{ page_obj.next_page_number }}{% if culture_id %}&culture_id={{ culture_id }}{% endif %}"
            class="flex items-center justify-center px-3 h-8 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700"
          >
            Próxima
            <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M1 5h12m0 0L9 1m4 4L9 9" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
          </a>
        {% else %}
          <button
            class="flex items-center justify-center px-3 h-8 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
            disabled
          >
            Próxima
            <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" fill="none" viewBox="0 0 14 10">
              <path d="M1 5h12m0 0L9 1m4 4L9 9" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
          </button>
        {% endif %}
      </div>
    {% endif %}
    </div>
  </div>
</div>
{% endblock %}
